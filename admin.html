<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ - ì½”ì–´ìœ„ë¸Œ ìŠ¤í…Œì´í‚¹</title>
    <script>
      // Firebase Analytics IndexedDB ê²½ê³  í•„í„°ë§
      (function() {
        const originalError = console.error;
        const originalWarn = console.warn;
        
        const filterMessage = (args) => {
          const message = args.map(arg => {
            if (typeof arg === 'string') return arg;
            if (arg && typeof arg.toString === 'function') return arg.toString();
            return JSON.stringify(arg);
          }).join(' ');
          
          // Analytics IndexedDB ê²½ê³  í•„í„°ë§
          if (message.includes('Analytics') && 
              (message.includes('IndexedDB') || 
               message.includes('indexeddb-unavailable') ||
               message.includes('analytics/indexeddb-unavailable'))) {
            return true;
          }
          
          // Firestore ì¸ë±ìŠ¤ ì˜¤ë¥˜ í•„í„°ë§ (fallbackìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—ëŸ¬ë¡œ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
          if (message.includes('Firestore ë¦¬ì›Œë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨') &&
              message.includes('The query requires an index')) {
            return true;
          }
          
          return false;
        };
        
        console.error = function(...args) {
          if (filterMessage(args)) {
            return;
          }
          originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
          if (filterMessage(args)) {
            return;
          }
          originalWarn.apply(console, args);
        };
      })();
    </script>
    <link rel="stylesheet" href="./styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .admin-container {
        min-height: 100vh;
        padding: 20px;
        background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      }
      .admin-header {
        background: linear-gradient(135deg, #0052CC 0%, #0047AB 100%);
        padding: 20px 40px;
        margin-bottom: 32px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .admin-header h1 {
        color: white;
        font-size: 24px;
        font-weight: 700;
        margin: 0;
      }
      .admin-content {
        max-width: 1400px;
        margin: 0 auto;
      }
      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-content">
        <!-- Admin Header -->
        <div class="admin-header">
          <h1>ğŸ” ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ</h1>
          <a href="/" class="back-btn">â† í™ˆìœ¼ë¡œ</a>
        </div>

        <!-- Admin Dashboard Content -->
        <div id="adminPageContent" style="width: 100%; min-height: 500px;">
          <div class="card glass" style="padding: 40px; text-align: center;">
            <p style="color: #9ca3af; font-size: 16px;">ì´ˆê¸°í™” ì¤‘...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-backdrop" id="loginModal">
      <div class="modal glass">
        <div class="modal-header">
          <h2 class="modal-title" id="loginModalTitle">ë¡œê·¸ì¸</h2>
          <button class="modal-close" id="loginCloseBtn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="loginEmail">ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼ ì£¼ì†Œ</label>
            <input
              type="text"
              id="loginEmail"
              class="input"
              placeholder="ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
              autocomplete="username"
            />
          </div>
          <div class="form-group">
            <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              type="password"
              id="loginPassword"
              class="input"
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
              autocomplete="current-password"
            />
          </div>
          <button class="btn-primary w-full" id="loginConfirmBtn">ë¡œê·¸ì¸</button>
          <p id="loginStatusText" style="text-align:center;margin-top:16px;color:var(--text-muted);font-size:14px;"></p>
          <div style="text-align:center;margin-top:16px;display:none;">
            <button class="btn-outline" id="toSignup" style="font-size:14px;padding:8px 16px;display:none;">íšŒì›ê°€ì…</button>
            <button class="btn-outline" id="toLogin" style="font-size:14px;padding:8px 16px;display:none;">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
          </div>
          <p style="text-align:center;margin-top:16px;color:#9ca3af;font-size:12px;">ê´€ë¦¬ì ê³„ì •ë§Œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>

    <!-- Reward Edit Modal -->
    <div class="modal-backdrop" id="rewardEditModal">
      <div class="modal glass" style="max-width: 500px;">
        <div class="modal-header">
          <h2 class="modal-title">ë¦¬ì›Œë“œ ë‚´ì—­ ìˆ˜ì •</h2>
          <button class="modal-close" id="rewardEditCloseBtn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="form-group" style="margin-bottom: 16px;">
            <label for="editRewardAmount" style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);">ë¦¬ì›Œë“œ ìˆ˜ëŸ‰</label>
            <input
              type="number"
              id="editRewardAmount"
              class="input"
              placeholder="ì˜ˆ: 0.5"
              min="0"
              step="0.0001"
              style="width:100%;"
            />
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label for="editRewardApy" style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);">APY (%)</label>
            <input
              type="number"
              id="editRewardApy"
              class="input"
              placeholder="ì˜ˆ: 8.5"
              min="0"
              step="0.1"
              style="width:100%;"
            />
          </div>
          <div class="form-group" style="margin-bottom: 24px;">
            <label for="editRewardDate" style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);">ë‚ ì§œ</label>
            <input
              type="date"
              id="editRewardDate"
              class="input"
              style="width:100%;"
            />
          </div>
          <div style="display: flex; gap: 12px;">
            <button class="btn-primary" id="rewardUpdateBtn" style="flex: 1; padding: 12px;">ìˆ˜ì •</button>
            <button class="btn-outline" id="rewardDeleteBtn" style="flex: 1; padding: 12px; color: #ef4444; border-color: #ef4444;">ì‚­ì œ</button>
          </div>
          <p id="rewardEditStatusText" style="text-align:center;margin-top:16px;color:var(--text-muted);font-size:14px;"></p>
        </div>
      </div>
    </div>

    <!-- Firebase core (Auth/Firestore) ì´ˆê¸°í™” -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
      import {
        getFirestore,
      } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyBvb8p8PFmeIh3ZVyWqWk1RQLBZyAUpfk4',
        authDomain: 'j22j22.firebaseapp.com',
        projectId: 'j22j22',
        storageBucket: 'j22j22.firebasestorage.app',
        messagingSenderId: '874202688810',
        appId: '1:874202688810:web:d384f6ea7cc4dcfb0b4253',
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.__firebase = {
        app,
        auth,
        db,
        onAuthStateChanged,
      };
      window.__firebaseInitialized = true;
    </script>

    <script src="./script.js"></script>
    <script>
      // ì–´ë“œë¯¼ í˜ì´ì§€ ì „ìš© ì´ˆê¸°í™”
      // ADMIN_EMAIL, currentUser, isAdmin, auth, db, $ëŠ” script.jsì—ì„œ ì´ë¯¸ ì „ì—­ìœ¼ë¡œ ì„ ì–¸ë¨
      // admin.htmlì—ì„œëŠ” window.__firebaseë¥¼ í†µí•´ ì ‘ê·¼

      async function initAdmin() {
        const container = $('#adminPageContent');
        
        if (!window.__firebase) {
          console.warn('Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          if (container) {
            container.innerHTML = `
              <div class="card glass" style="padding: 40px; text-align: center;">
                <p style="color: #9ca3af; font-size: 16px;">Firebase ì´ˆê¸°í™” ì¤‘...</p>
              </div>
            `;
          }
          setTimeout(initAdmin, 100);
          return;
        }

        // script.jsì˜ ì „ì—­ ë³€ìˆ˜ëŠ” ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¡œì»¬ ë³€ìˆ˜ ì‚¬ìš©
        const firebaseAuth = window.__firebase.auth;
        const firebaseDb = window.__firebase.db;
        
        // script.jsì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ìœ¼ë¡œ ì„¤ì •
        if (typeof window !== 'undefined') {
          window.db = firebaseDb;
          window.auth = firebaseAuth;
        }

        const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js');
        
        // ì¦‰ì‹œ í˜„ì¬ ì¸ì¦ ìƒíƒœ í™•ì¸
        const currentAuthUser = firebaseAuth.currentUser;
        console.log('í˜„ì¬ ì¸ì¦ ìƒíƒœ:', currentAuthUser ? currentAuthUser.email : 'ë¡œê·¸ì¸ ì•ˆ ë¨');
        
        onAuthStateChanged(firebaseAuth, async (user) => {
          console.log('ì¸ì¦ ìƒíƒœ ë³€ê²½:', user ? user.email : 'ë¡œê·¸ì•„ì›ƒ');
          
          if (container) {
            container.innerHTML = `
              <div class="card glass" style="padding: 40px; text-align: center;">
                <p style="color: #9ca3af; font-size: 16px;">ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...</p>
              </div>
            `;
          }
          
          if (user) {
            // script.jsì˜ ì „ì—­ ë³€ìˆ˜ëŠ” ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¡œì»¬ ë³€ìˆ˜ ì‚¬ìš©
            const userEmail = user.email;
            const userUid = user.uid;
            
            // ADMIN_EMAILì€ script.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„ ì–¸ë¨
            const adminEmail = typeof ADMIN_EMAIL !== 'undefined' ? ADMIN_EMAIL : 'jjiyu244@gmail.com';
            const userIsAdmin = userEmail && userEmail.toLowerCase() === adminEmail.toLowerCase();
            
            if (!userIsAdmin) {
              // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ìë™ ë¡œê·¸ì•„ì›ƒ
              const { signOut } = await import('https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js');
              await signOut(firebaseAuth);
              
              if (container) {
                container.innerHTML = `
                  <div class="card glass" style="padding: 40px; text-align: center;">
                    <h3 style="color: #ef4444; font-size: 20px; margin-bottom: 16px;">âŒ ì–´ë“œë¯¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                    <p style="color: #9ca3af; font-size: 16px; margin-bottom: 12px;">í˜„ì¬ ê³„ì •: ${user.email}</p>
                    <p style="color: #9ca3af; font-size: 14px; margin-bottom: 24px;">í—ˆìš©ëœ ê³„ì •: ${adminEmail}</p>
                    <button class="btn-primary" id="showLoginBtnAgain" style="padding: 12px 24px; font-size: 16px; margin-top: 16px;">ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ê¸°</button>
                  </div>
                `;
                
                // ë‹¤ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
                const showLoginBtnAgain = $('#showLoginBtnAgain');
                if (showLoginBtnAgain) {
                  showLoginBtnAgain.addEventListener('click', () => {
                    const loginModal = $('#loginModal');
                    if (loginModal) {
                      loginModal.classList.add('show');
                    }
                  });
                }
              }
              
              // ë¡œê·¸ì¸ ëª¨ë‹¬ ìë™ í‘œì‹œ
              setTimeout(() => {
                const loginModal = $('#loginModal');
                if (loginModal) {
                  loginModal.classList.add('show');
                }
              }, 500);
              return;
            }
            
            // ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ ë Œë”ë§
            if (container) {
              container.innerHTML = '<div class="card glass" style="padding: 40px; text-align: center;"><p style="color: #9ca3af; font-size: 16px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
            }
            
            try {
              console.log('ì–´ë“œë¯¼ ë°ì´í„° ë¡œë”© ì‹œì‘...');
              
              // script.jsì˜ dbë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì „ì—­ ë³€ìˆ˜ ì„¤ì •
              if (typeof window !== 'undefined' && !window.db) {
                window.db = firebaseDb;
              }
              
              // loadAllUserStakes í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
              if (typeof loadAllUserStakes !== 'function') {
                throw new Error('loadAllUserStakes í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. script.jsê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
              }
              
              console.log('loadAllUserStakes í•¨ìˆ˜ í˜¸ì¶œ ì¤‘...');
              let users;
              try {
                users = await loadAllUserStakes();
                console.log('ë¡œë“œëœ ì‚¬ìš©ì ìˆ˜:', users.length);
                if (users.length === 0) {
                  console.warn('âš ï¸ ì‚¬ìš©ì ë°ì´í„°ê°€ 0ëª…ì…ë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:');
                  console.warn('1. Firestore ì½˜ì†”ì—ì„œ stake ì»¬ë ‰ì…˜ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸');
                  console.warn('2. Firestore ë³´ì•ˆ ê·œì¹™ì—ì„œ stake ì»¬ë ‰ì…˜ ì½ê¸° ê¶Œí•œ í™•ì¸');
                  console.warn('3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ loadAllUserStakes ê´€ë ¨ ì—ëŸ¬ í™•ì¸');
                }
              } catch (error) {
                console.error('âŒ loadAllUserStakes í˜¸ì¶œ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
                console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
                console.error('ì—ëŸ¬ ì½”ë“œ:', error.code);
                users = [];
              }
              
              if (container) {
                // renderAdminDashboardContent í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (typeof renderAdminDashboardContent !== 'function') {
                  throw new Error('renderAdminDashboardContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                console.log('ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì¤‘...');
                await renderAdminDashboardContent(users, container);
                console.log('ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì™„ë£Œ');
              }
              
              // ë¦¬ì›Œë“œ ìˆ˜ì • ëª¨ë‹¬ ì„¤ì • (script.jsì˜ í•¨ìˆ˜ ì‚¬ìš©)
              if (typeof setupRewardEditModal === 'function') {
                setupRewardEditModal();
              }
            } catch (error) {
              console.error('ì–´ë“œë¯¼ í˜ì´ì§€ ë Œë”ë§ ì¤‘ ìƒì„¸ ì˜¤ë¥˜:', error);
              console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
              console.error('ì–´ë“œë¯¼ í˜ì´ì§€ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:', error);
              if (container) {
                let errorMessage = error.message;
                let errorDetails = '';
                
                // Firestore ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš°
                if (error.message && (error.message.includes('Permission denied') || 
                    error.message.includes('Missing or insufficient permissions'))) {
                  errorMessage = 'Firestore ë³´ì•ˆ ê·œì¹™ ì˜¤ë¥˜';
                  errorDetails = `
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 8px; margin-top: 16px; text-align: left;">
                      <p style="color: #fca5a5; font-size: 14px; margin: 0 0 8px 0;"><strong>í•´ê²° ë°©ë²•:</strong></p>
                      <ol style="color: #fca5a5; font-size: 14px; margin: 0; padding-left: 20px;">
                        <li>Firebase ì½˜ì†” ì ‘ì†: <a href="https://console.firebase.google.com/project/j22j22/firestore/rules" target="_blank" style="color: #93c5fd;">Firestore ê·œì¹™ ì„¤ì •</a></li>
                        <li>ì–´ë“œë¯¼ ê³„ì •(jjiyu244@gmail.com)ì´ ëª¨ë“  userStakes ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆë„ë¡ ê·œì¹™ ìˆ˜ì •</li>
                        <li>ê·œì¹™ ì €ì¥ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</li>
                      </ol>
                      <p style="color: #fca5a5; font-size: 12px; margin: 12px 0 0 0;">ìì„¸í•œ ë‚´ìš©ì€ FIREBASE_FIX_GUIDE.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.</p>
                    </div>
                  `;
                }
                
                container.innerHTML = `
                  <div class="card glass" style="padding: 40px; text-align: center;">
                    <h3 style="color: #ef4444; font-size: 20px; margin-bottom: 12px;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
                    <p style="color: #fca5a5; font-size: 16px; margin-bottom: 8px;">${errorMessage}</p>
                    ${errorDetails}
                    <button class="btn-primary" onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px;">ìƒˆë¡œê³ ì¹¨</button>
                  </div>
                `;
              }
            }
          } else {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ
            if (container) {
              container.innerHTML = `
                <div class="card glass" style="padding: 40px; text-align: center;">
                  <h3 style="color: #ffffff; font-size: 20px; margin-bottom: 16px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                  <p style="color: #9ca3af; font-size: 16px; margin-bottom: 24px;">ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œì— ì ‘ê·¼í•˜ë ¤ë©´ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                  <button class="btn-primary" id="showLoginBtn" style="padding: 12px 24px; font-size: 16px;">ë¡œê·¸ì¸í•˜ê¸°</button>
                </div>
              `;
              
              // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
              const showLoginBtn = $('#showLoginBtn');
              if (showLoginBtn) {
                showLoginBtn.addEventListener('click', () => {
                  const loginModal = $('#loginModal');
                  if (loginModal) {
                    loginModal.classList.add('show');
                  }
                });
              }
            }
            
            // ë¡œê·¸ì¸ ëª¨ë‹¬ ìë™ í‘œì‹œ
            setTimeout(() => {
              const loginModal = $('#loginModal');
              if (loginModal) {
                loginModal.classList.add('show');
              }
            }, 300);
          }
        });
      }


      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', async () => {
        // ë¡œê·¸ì¸ UI ì„¤ì • (admin.htmlì—ì„œë„ ì‚¬ìš©)
        if (typeof setupLogin === 'function') {
          await setupLogin();
        }
        initAdmin();
      });
    </script>
  </body>
</html>

