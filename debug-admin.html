<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ê¶Œí•œ ì§„ë‹¨ ë„êµ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #b3d9ff;
        }
        .error-box {
            background: #ffe7e7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ffb3b3;
        }
        .success-box {
            background: #e7ffe7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #b3ffb3;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ê´€ë¦¬ì ê¶Œí•œ ì§„ë‹¨ ë„êµ¬</h1>
        
        <div class="info-box">
            <strong>ì‚¬ìš© ë°©ë²•:</strong><br>
            1. ë¨¼ì € <code>jjiyu1@corestaker.local</code> ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
            2. ì•„ë˜ "ì§„ë‹¨ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br>
            3. ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì·¨í•˜ì„¸ìš”.
        </div>

        <button onclick="runDiagnostics()">ğŸ” ì§„ë‹¨ ì‹œì‘</button>
        <button onclick="fixUserDocument()">ğŸ”§ Firestore ë¬¸ì„œ ìˆ˜ì •</button>

        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            query,
            where
        } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: 'AIzaSyBvb8p8PFmeIh3ZVyWqWk1RQLBZyAUpfk4',
            authDomain: 'j22j22.firebaseapp.com',
            projectId: 'j22j22',
            storageBucket: 'j22j22.firebasestorage.app',
            messagingSenderId: '874202688810',
            appId: '1:874202688810:web:d384f6ea7cc4dcfb0b4253',
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.runDiagnostics = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info-box">ì§„ë‹¨ ì¤‘...</div>';

            const diagnostics = [];

            // 1. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì í™•ì¸
            const user = auth.currentUser;
            if (!user) {
                resultsDiv.innerHTML = `
                    <div class="error-box">
                        <h3>âŒ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
                        <p>ë¨¼ì € jjiyu1@corestaker.local ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            diagnostics.push({
                title: '1. Firebase Auth ì‚¬ìš©ì ì •ë³´',
                status: 'success',
                data: {
                    email: user.email,
                    uid: user.uid,
                    emailVerified: user.emailVerified
                }
            });

            // 2. Firestoreì—ì„œ UIDë¡œ ì‚¬ìš©ì ë¬¸ì„œ ì°¾ê¸°
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    diagnostics.push({
                        title: '2. Firestore ì‚¬ìš©ì ë¬¸ì„œ (UIDë¡œ ì°¾ê¸°)',
                        status: 'success',
                        data: {
                            documentId: userSnap.id,
                            exists: true,
                            data: userData,
                            role: userData.role,
                            username: userData.username,
                            email: userData.email
                        }
                    });

                    // role í™•ì¸
                    if (userData.role === 'admin') {
                        diagnostics.push({
                            title: '3. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸',
                            status: 'success',
                            data: {
                                role: userData.role,
                                message: 'âœ… role í•„ë“œê°€ "admin"ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤!'
                            }
                        });
                    } else {
                        diagnostics.push({
                            title: '3. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸',
                            status: 'error',
                            data: {
                                role: userData.role || '(ì—†ìŒ)',
                                message: 'âŒ role í•„ë“œê°€ "admin"ì´ ì•„ë‹™ë‹ˆë‹¤. "admin"ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.'
                            }
                        });
                    }
                } else {
                    diagnostics.push({
                        title: '2. Firestore ì‚¬ìš©ì ë¬¸ì„œ (UIDë¡œ ì°¾ê¸°)',
                        status: 'error',
                        data: {
                            documentId: user.uid,
                            exists: false,
                            message: 'âŒ UIDë¡œ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.'
                        }
                    });
                }
            } catch (error) {
                diagnostics.push({
                    title: '2. Firestore ì‚¬ìš©ì ë¬¸ì„œ ì¡°íšŒ',
                    status: 'error',
                    data: {
                        error: error.message,
                        code: error.code
                    }
                });
            }

            // 3. ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ë¬¸ì„œ ì°¾ê¸° (ë‹¤ë¥¸ ë¬¸ì„œ IDì¼ ìˆ˜ ìˆìŒ)
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', user.email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const foundDocs = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        data: doc.data()
                    }));

                    diagnostics.push({
                        title: '4. ì´ë©”ì¼ë¡œ ì°¾ì€ ë¬¸ì„œë“¤',
                        status: querySnapshot.docs.some(d => d.id === user.uid) ? 'success' : 'error',
                        data: {
                            documents: foundDocs,
                            message: querySnapshot.docs.some(d => d.id === user.uid) 
                                ? 'âœ… ì´ë©”ì¼ë¡œ ì°¾ì€ ë¬¸ì„œ ì¤‘ UIDì™€ ì¼ì¹˜í•˜ëŠ” ë¬¸ì„œê°€ ìˆìŠµë‹ˆë‹¤.'
                                : 'âš ï¸ ì´ë©”ì¼ë¡œ ì°¾ì€ ë¬¸ì„œì˜ IDê°€ í˜„ì¬ UIDì™€ ë‹¤ë¦…ë‹ˆë‹¤!'
                        }
                    });
                } else {
                    diagnostics.push({
                        title: '4. ì´ë©”ì¼ë¡œ ì°¾ì€ ë¬¸ì„œë“¤',
                        status: 'error',
                        data: {
                            message: 'âŒ ì´ë©”ì¼ë¡œ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
                        }
                    });
                }
            } catch (error) {
                diagnostics.push({
                    title: '4. ì´ë©”ì¼ë¡œ ë¬¸ì„œ ê²€ìƒ‰',
                    status: 'error',
                    data: {
                        error: error.message,
                        code: error.code,
                        note: error.code === 'failed-precondition' ? 'ì¸ë±ìŠ¤ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : ''
                    }
                });
            }

            // ê²°ê³¼ í‘œì‹œ
            let html = '<h2>ì§„ë‹¨ ê²°ê³¼</h2>';
            diagnostics.forEach((diag, index) => {
                const boxClass = diag.status === 'success' ? 'success-box' : 'error-box';
                html += `
                    <div class="step">
                        <h3>${diag.title}</h3>
                        <div class="${boxClass}">
                            <pre>${JSON.stringify(diag.data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            });

            // ê¶Œì¥ ì‚¬í•­
            html += `
                <div class="info-box">
                    <h3>ğŸ“‹ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­:</h3>
                    <ol>
                        <li>Firestoreì˜ <code>users</code> ì»¬ë ‰ì…˜ì—ì„œ ë¬¸ì„œ IDê°€ <strong>UIDì™€ ì¼ì¹˜</strong>í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</li>
                        <li>ë¬¸ì„œì˜ <code>role</code> í•„ë“œê°€ ì •í™•íˆ <strong>"admin"</strong> (ë”°ì˜´í‘œ í¬í•¨)ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</li>
                        <li>ë¬¸ì„œ IDê°€ UIDì™€ ë‹¤ë¥´ë‹¤ë©´, ì˜¬ë°”ë¥¸ ë¬¸ì„œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ìƒˆ ë¬¸ì„œë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                        <li>ìœ„ì˜ "Firestore ë¬¸ì„œ ìˆ˜ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ol>
                </div>
            `;

            resultsDiv.innerHTML = html;
        };

        window.fixUserDocument = async function() {
            const user = auth.currentUser;
            if (!user) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    // ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸
                    await updateDoc(userRef, {
                        role: 'admin',
                        email: user.email,
                        username: 'jjiyu1'
                    });
                    alert('âœ… ì‚¬ìš©ì ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\nrole: admin\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                } else {
                    // ìƒˆ ë¬¸ì„œ ìƒì„±
                    await setDoc(userRef, {
                        email: user.email,
                        username: 'jjiyu1',
                        role: 'admin',
                        createdAt: new Date()
                    });
                    alert('âœ… ì‚¬ìš©ì ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nrole: admin\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                }
            } catch (error) {
                alert('âŒ ì˜¤ë¥˜: ' + error.message);
                console.error(error);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì:', user.email, user.uid);
            }
        });
    </script>
</body>
</html>