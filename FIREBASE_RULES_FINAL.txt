rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 어드민 이메일 확인 함수 (여러 형식 지원)
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'jjiyu244@corestaker.local' ||
        request.auth.token.email == 'jjiyu244@temp.com' ||
        request.auth.token.email == 'jjiyu244@gmail.com'
      );
    }
    
    // users 컬렉션 (사용자 정보)
    match /users/{userId} {
      // 본인 데이터는 읽기/쓰기 가능
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // 어드민은 모든 사용자 데이터 읽기 가능
      allow read: if isAdmin();
    }
    
    // staking_requests 컬렉션 (스테이킹 신청)
    match /staking_requests/{requestId} {
      // 본인 신청은 읽기 가능
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      // 로그인한 사용자는 신청 작성 가능
      allow create: if request.auth != null;
      // 어드민은 모든 신청 읽기/쓰기 가능
      allow read, write: if isAdmin();
    }
    
    // userStakes 컬렉션
    match /userStakes/{userId} {
      // 본인 데이터는 읽기/쓰기 가능
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // 어드민은 모든 데이터 읽기/쓰기 가능
      allow read, write: if isAdmin();
    }
    
    // stake 컬렉션 (개별 스테이킹 거래)
    match /stake/{stakeId} {
      // 본인 스테이킹 거래는 읽기 가능
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.user_uid;
      // 어드민은 모든 스테이킹 거래 읽기/쓰기 가능
      allow read, write: if isAdmin();
      // 로그인한 사용자는 자신의 스테이킹 거래 작성 가능
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.user_uid;
    }
    
    // rewards 컬렉션
    match /rewards/{rewardId} {
      // 본인 리워드는 읽기 가능
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      // 어드민은 모든 리워드 읽기/쓰기 가능
      allow read, write: if isAdmin();
    }
    
    // inquiries 컬렉션
    match /inquiries/{inquiryId} {
      // 본인 문의는 읽기 가능
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      // 어드민은 모든 문의 읽기 가능
      allow read: if isAdmin();
      // 로그인한 사용자는 문의 작성 가능
      allow create: if request.auth != null;
    }
    
    // 기타 문서는 로그인한 사용자만 접근
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
